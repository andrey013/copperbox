{

{-# LANGUAGE ScopedTypeVariables #-}

--------------------------------------------------------------------------------
-- |
-- Module      :  Mullein.Gen.LilyPondConvert
-- Copyright   :  (c) Stephen Tetley 2009
-- License     :  BSD-style (as per the Haskell Hierarchical Libraries)
--
-- Maintainer  :  Stephen Tetley <stephen.tetley@gmail.com>
-- Stability   :  highly unstable
-- Portability :  to be determined.
--
-- Convert internal form to LilyPond 
--
--------------------------------------------------------------------------------
}

{
module Mullein.Gen.LilyPondConvert where

import Mullein.Core
import Mullein.CoreTypes
import Mullein.Duration
import qualified Mullein.Gen.LilyPondSyntax as Ly
import Mullein.Gen.Syntax
import Mullein.Pitch

import Data.Ratio
import Text.PrettyPrint.Leijen 

}

INCLUDE "SyntaxDEFS.ag"



-- Propagate relative duration to the elements 


ATTR Every [ | rduration : {Duration} | ]
ATTR Every [ | rpitch : {Pitch} | ]

ATTR Every [ trafoPitch : {(Pitch -> Pitch -> Pitch)} | | ]

SEM Elements 
  | Cons        tl.rduration   = @hd.getDuration


ATTR Element [ | | getDuration : {Duration} ]

SEM Element 
  | Note        lhs.getDuration = @duration
  | Rest        lhs.getDuration = @duration 
  | Spacer      lhs.getDuration = @duration
  | Chord       lhs.getDuration = @duration         
  | GraceNotes  lhs.getDuration = 0                             
  | Nplet       lhs.getDuration = error "Nplet getDuration"

SEM Elements 
  | Cons        tl.rpitch      = @hd.getPitch

ATTR Element GraceNotes GraceNote Pitches [ | | getPitch : {Pitch} ]

SEM Element 
  | Note        lhs.getPitch    = @pitch
  | Rest        lhs.getPitch    = @lhs.rpitch  -- just pass on rpitch 
  | Spacer      lhs.getPitch    = @lhs.rpitch
  | Chord       lhs.getPitch    = @pitches.getPitch       
  | GraceNotes  lhs.getPitch    = @graces.getPitch                             
  | Nplet       lhs.getPitch    = error "Nplet getPitch"

-- First pitch of the list
SEM GraceNotes 
  | Cons        lhs.getPitch    = @hd.getPitch
  | Nil         lhs.getPitch    = @lhs.rpitch

SEM GraceNote
  | Tuple       lhs.getPitch    = @pch

-- First pitch of the list
SEM Pitches
  | Cons        lhs.getPitch    = @hd
  | Nil         lhs.getPitch    = @lhs.rpitch
 

-- Convert 

ATTR Section [ | | convert : {Ly.Section} ]

SEM Section
  | Section     lhs.convert    = Ly.Section @bars.convert


ATTR Bars [ | | convert USE {:} {[]} : {[Ly.Bar]} ]
ATTR Bar  [ | | convert : {Ly.Bar} ]


SEM Bar
  | Bar         lhs.convert    = Ly.Bar @voice.convert
  | Overlay     lhs.convert    = Ly.Overlay @ovs.convert

ATTR VoiceUnits [ | | convert USE {:} {[]} : {[Ly.VoiceUnit]} ]
ATTR VoiceUnit  [ | | convert : {Ly.VoiceUnit} ]


SEM VoiceUnit
  | VoiceUnit   lhs.convert    = Ly.VoiceUnit @pulses.convert @tied

ATTR Pulsations [ | | convert USE {:} {[]} : {[Ly.Pulsation]} ]
ATTR Pulsation  [ | | convert : {Ly.Pulsation} ]

SEM Pulsation
  | SingleElt   lhs.convert    = Ly.SingleElt @elt.convert
  | BeamedGroup lhs.convert    = Ly.BeamedGroup @elts.convert


ATTR Elements [ | | convert USE {:} {[]} : {[Ly.Element]} ]
ATTR Element  [ | | convert : {Ly.Element} ]

SEM Element
  | Note        lhs.convert   = let f = @lhs.trafoPitch  in 
                                Ly.Note (f @lhs.rpitch @pitch) 
                                        (relativeDuration @lhs.rduration @duration)
  | Rest        lhs.convert   = Ly.Rest $ relativeDuration @lhs.rduration @duration
  | Spacer      lhs.convert   = Ly.Spacer $ relativeDuration @lhs.rduration @duration
  | Chord       lhs.convert   = error "Ly.Chord"
  | GraceNotes  lhs.convert   = error "Ly.GraceNotes"
  | Nplet       lhs.convert   = error "Ly.Nplet"




{

convertToLy :: (Pitch -> Pitch -> Pitch) -> Pitch -> Section -> Ly.Section
convertToLy pchFun relpitch e = convert_Syn_Section synthesized 
  where
    synthesized = wrap_Section (sem_Section e) inherited
    inherited   = Inh_Section { rduration_Inh_Section  = 1%4,
                                rpitch_Inh_Section     = relpitch,
                                trafoPitch_Inh_Section = pchFun   } 

relativeDuration :: Duration -> Duration -> Maybe Duration
relativeDuration ud drn | ud == drn = Nothing
                        | otherwise = Just drn


-- LilyPond middle c is c' (aka `c 1`)
-- Mullein middle c is c4
absPitch :: Pitch -> Pitch -> Pitch
absPitch _ (Pitch l a o) = Pitch l a (o-3)


relPitch :: Pitch -> Pitch -> Pitch
relPitch rel pch@(Pitch l a _) = Pitch l a (pch `octaveDist` rel)


}                
                
          